name: Deploy to Azure AKS

on:
  push:
    branches: [azure-deployment]
  pull_request:
    branches: [azure-deployment]

env:
  ACR_NAME: ${{ vars.ACR_NAME }}                 # e.g. mydocsacr
  ACR_LOGIN_SERVER: ${{ vars.ACR_NAME }}.azurecr.io
  AKS_CLUSTER: ${{ vars.AKS_CLUSTER_NAME }}      # e.g. mydocs-aks
  AKS_RESOURCE_GROUP: ${{ vars.AKS_RESOURCE_GROUP }}
  K8S_NAMESPACE: mydocs
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ── Build & push Docker images ────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write          # needed for OIDC login to Azure

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ACR login
        run: az acr login --name "$ACR_NAME"

      - name: Build & push backend image
        run: |
          docker build -f Dockerfile.backend \
            -t "$ACR_LOGIN_SERVER/mydocs-backend:$IMAGE_TAG" \
            -t "$ACR_LOGIN_SERVER/mydocs-backend:latest" \
            .
          docker push "$ACR_LOGIN_SERVER/mydocs-backend:$IMAGE_TAG"
          docker push "$ACR_LOGIN_SERVER/mydocs-backend:latest"

      - name: Build & push UI image
        run: |
          docker build -f Dockerfile.ui \
            --build-arg VITE_API_BASE_URL=/api/v1 \
            --build-arg VITE_ENTRA_CLIENT_ID=${{ secrets.ENTRA_CLIENT_ID }} \
            --build-arg VITE_ENTRA_AUTHORITY=${{ secrets.ENTRA_AUTHORITY }} \
            -t "$ACR_LOGIN_SERVER/mydocs-ui:$IMAGE_TAG" \
            -t "$ACR_LOGIN_SERVER/mydocs-ui:latest" \
            .
          docker push "$ACR_LOGIN_SERVER/mydocs-ui:$IMAGE_TAG"
          docker push "$ACR_LOGIN_SERVER/mydocs-ui:latest"

  # ── Deploy to AKS ─────────────────────────────────────────────────────
  deploy:
    needs: build
    if: github.event_name == 'push'   # only deploy on merge/push, not on PR open
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get AKS credentials
        run: |
          az aks get-credentials \
            --resource-group "$AKS_RESOURCE_GROUP" \
            --name "$AKS_CLUSTER" \
            --overwrite-existing

      - name: Create namespace (idempotent)
        run: kubectl apply -f deploy/k8s/namespace.yml

      - name: Apply K8s manifests
        run: |
          kubectl apply -f deploy/k8s/configmap.yml
          kubectl apply -f deploy/k8s/pvc.yml
          kubectl apply -f deploy/k8s/secret.yml
          kubectl apply -f deploy/k8s/backend-deployment.yml
          kubectl apply -f deploy/k8s/backend-service.yml
          kubectl apply -f deploy/k8s/ui-deployment.yml
          kubectl apply -f deploy/k8s/ui-service.yml
          kubectl apply -f deploy/k8s/oauth2-proxy.yml
          kubectl apply -f deploy/k8s/ingress.yml

      - name: Update images to new tag
        run: |
          kubectl set image deployment/backend \
            backend="$ACR_LOGIN_SERVER/mydocs-backend:$IMAGE_TAG" \
            -n "$K8S_NAMESPACE"
          kubectl set image deployment/ui \
            ui="$ACR_LOGIN_SERVER/mydocs-ui:$IMAGE_TAG" \
            -n "$K8S_NAMESPACE"

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/backend -n "$K8S_NAMESPACE" --timeout=300s
          kubectl rollout status deployment/ui -n "$K8S_NAMESPACE" --timeout=300s

      - name: Deployment summary
        run: |
          echo "### Deployment complete" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Backend:** $ACR_LOGIN_SERVER/mydocs-backend:$IMAGE_TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "- **UI:** $ACR_LOGIN_SERVER/mydocs-ui:$IMAGE_TAG" >> "$GITHUB_STEP_SUMMARY"
          echo "- **Cluster:** $AKS_CLUSTER ($AKS_RESOURCE_GROUP)" >> "$GITHUB_STEP_SUMMARY"
